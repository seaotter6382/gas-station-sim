<html>
    <head>
        <style>
            #userPlayer { height: 50px; width: 50px; background-color: blue; position: absolute; z-index: 1; border-radius: 2px; }
            .font { font-family: "monospace", sans-serif; }
            #test { background-color: rgb(163, 87, 0);}
        </style>
    </head>
    <body>
        <div id="userPlayer"></div>
        <script type="module">
            import { getKeybinds } from "./lib/fetch/fetchKeybinds.js";
            import { getColors } from "./lib/fetch/fetchColors.js";
            import { createProx } from "./lib/prox/createProx.js";
            import { renderProx } from "./lib/prox/renderProx.js";
            import { createObject } from "./lib/objects/createObject.js";
            import { renderObjects, collide } from "./lib/objects/renderObject.js";
            let keybinds = await getKeybinds();
            console.log(keybinds);
            let colors = await getColors();
            console.log(colors);
            let useArrowKeys = keybinds['useArrow'];
            let keys = {};
            let prox = [];
            let pos = {x: window.innerWidth / 2 - 25, y: window.innerHeight / 2 - 25};
            let speed = 2;
            let mainPlayer = document.getElementById("userPlayer");
            mainPlayer.style.width = "50px";
            mainPlayer.style.height = "50px";
            document.addEventListener("keydown", (event) => {
                keys[event.key] = true;
            });
            document.addEventListener("keyup", (event) => {
                delete keys[event.key];
            });
            window.addEventListener("resize", () => {
                location.reload();
            });
            document.body.style.backgroundColor = colors["background"];

            // base blocks
            collide.push(createObject(-90, 0, 10000, 100, colors["outerWall"], "left wall", 1));
            collide.push(createObject(window.innerWidth - 10, 0, 10000, 100, colors["outerWall"], "right wall", 1));
            collide.push(createObject(0, -90, 100, 100000, colors["outerWall"], "top wall", 1));
            collide.push(createObject(0, window.innerHeight - 10, 100, 100000, colors["outerWall"], "bottom wall", 1));

            // interactable blocks
            collide.push(createObject(0, 200, 100, 100, colors['interactables']['fridge'], "fridge1", 1));
            prox.push(createProx(0, 212.5, keybinds['use'], "fridge1Prox", "use fridge", 20));
            collide.push(createObject(100, 200, 100, 10, colors['interactables']['fridge'], "fridge1Door", 1));

            let pTime = 0;
            const f = 200;
            let size = 0;
            function gameLoop(currentTime) {
                let deltaTime = (currentTime - pTime) / 1000;
                pTime = currentTime;
                const e = f * deltaTime;
                if (useArrowKeys == "true") {
                    let nextPos = { x: pos.x, y: pos.y };
                    if (keys[keybinds['arrow']['left']]) nextPos.x -= e;
                    if (keys[keybinds['arrow']['right']]) nextPos.x += e;
                    if (keys[keybinds['arrow']['forward']]) nextPos.y -= e;
                    if (keys[keybinds['arrow']['backward']]) nextPos.y += e;
                    let isColliding = collide.some(c => {
                        let objectRect = c.getBoundingClientRect();
                        return (
                            nextPos.x < objectRect.right &&
                            nextPos.x + parseFloat(mainPlayer.style.width) > objectRect.left &&
                            nextPos.y < objectRect.bottom &&
                            nextPos.y + parseFloat(mainPlayer.style.height) > objectRect.top
                        );
                    });
                    if (!isColliding) {
                        pos.x = nextPos.x;
                        pos.y = nextPos.y;
                    }
                } else if (useArrowKeys == "false") {
                    let nextPos = { x: pos.x, y: pos.y };
                    if (keys[keybinds['left']]) nextPos.x -= e;
                    if (keys[keybinds['right']]) nextPos.x += e;
                    if (keys[keybinds['forward']]) nextPos.y -= e;
                    if (keys[keybinds['backward']]) nextPos.y += e;
                    let isColliding = collide.some(c => {
                        let objectRect = c.getBoundingClientRect();
                        return (
                            nextPos.x < objectRect.right &&
                            nextPos.x + parseFloat(mainPlayer.style.width) > objectRect.left &&
                            nextPos.y < objectRect.bottom &&
                            nextPos.y + parseFloat(mainPlayer.style.height) > objectRect.top
                        );
                    });
                    if (!isColliding) {
                        pos.x = nextPos.x;
                        pos.y = nextPos.y;
                    }
                }
                if (keys[keybinds['use']]) {
                    let closestProx = null;
                    let closestDistance = Infinity;
                    prox.forEach(p => {
                        let proxCenterX = parseFloat(p.style.left) + parseFloat(p.style.width) / 2;
                        let proxCenterY = parseFloat(p.style.top) + parseFloat(p.style.height) / 2;
                        let playerCenterX = pos.x + parseFloat(mainPlayer.style.width) / 2;
                        let playerCenterY = pos.y + parseFloat(mainPlayer.style.height) / 2;
                        let distance = Math.sqrt(Math.pow(proxCenterX - playerCenterX, 2) + Math.pow(proxCenterY - playerCenterY, 2));
                        if (distance < closestDistance) {
                            closestDistance = distance;
                            closestProx = p;
                        }
                    });
                    if (closestProx && closestDistance < 200) {
                        closestProx.querySelector("#miniCircle").style.transform = "scale(" + size + ")";
                        size += e / 50;
                        if (size > 5) {
                            if (closestProx.parentNode) {
                                closestProx.style.transform = "scale(0)";
                                if (closestProx.id == "fridge1Prox") {
                                    let fridgeDoor = document.querySelector("#fridge1Door");
                                    let hasRotated = false;
                                    if (hasRotated == false) {
                                        hasRotated = true;
                                        if (fridgeDoor.style.transform === "rotate(90deg)") {
                                            fridgeDoor.style.transform = "rotate(0deg)";
                                        } else {
                                            fridgeDoor.style.transform = "rotate(90deg)";
                                        }
                                    }
                                    console.log(fridgeDoor);
                                }
                                setTimeout(() => {
                                    closestProx.style.transform = "scale(1)";
                                }, 500);
                            }
                        }
                    }
                } else {
                    size = 0;
                    prox.forEach(p => {
                        if (p.querySelector("#miniCircle")) {
                            p.querySelector("#miniCircle").style.transform = "scale(0)";
                        }
                    });
                }
                if (keys[keybinds['use2']]) {
                    prox.push(createProx(pos.x - 50, pos.y - 12.5, keybinds['use'], "removeBlocks", "remove all blocks", 19));
                    delete keys[keybinds['use2']];
                }
                if (keys[keybinds['use3']]) {
                    console.log("created object");
                    collide.push(createObject(pos.x + 50, pos.y + 50, 100, 100, (0, 0, 0), Math.random(0, 1)));
                    delete keys[keybinds['use3']];
                }
                renderProx(prox, pos, mainPlayer);
                renderObjects(document);
                document.querySelector("#fridge1Door").style.transformOrigin = "bottom";
                document.querySelector("#fridge1Door").style.transition = "0.5s ease";
                if (pos.x < 0) pos.x = 0;
                if (pos.x > window.innerWidth - 50) pos.x = window.innerWidth - 50;
                if (pos.y < 0) pos.y = 0;
                if (pos.y > window.innerHeight - 50) pos.y = window.innerHeight - 50;
                mainPlayer.style.left = pos.x + "px";
                mainPlayer.style.top = pos.y + "px";
                requestAnimationFrame(gameLoop);
            }
            gameLoop();
        </script>
    </body>
</html>